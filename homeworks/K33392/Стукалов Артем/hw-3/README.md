# Fastify + Prisma + Zod API template

Небольшой темплейт для написания простеньких АПИ с упором на следующие аспекты:

- Полная типобезопасность. Достигается за счет строгих правил TS и автоматической генерации типов библиотекой `Prisma`
- Удобсвто валидации данных. Используем `Zod` в качестве валидатора запросов и языка схем запросов. Для интеграции с `Prisma` используем плагин `zod-prisma-types`.
- Скорость разработки и сборки проекта. Используем `swc` для компиляции typescript и nodemon для перезапуска проекта.

Про каждый пункт подробнее ниже:

## Типобезопасность и Prisma

Typescript - прекрасная вешь, которая может зашитить от огромного кол-ва глупых ошибок вроде опечаток или забытой проверки на null. Но чтобы использовать его по максимому, нужно для начала написать хорошую систему типов.  
В данном темплейте стараемся как можно больше работы переложить на компилятор и сократить до минимума использование `any` и тайпкастов через `as`.  
В качестве ORM используем `Prisma`. Эта библиотека полностью типо безопасна, так как не вынуждает нас самостоятельно писать типы для моделей, миграций и подобного. `Prisma` самостятельно генерирует типы моделй и сами модели, миграции от одной схемы БД к другой. Единственное, что на мнужно менять это файл схемы БД, который использует свой собственный синтаксис, поддержку которого очень легко добавить через плагин для VSCode(Prisma VS Code Extension).

## Zod

Для валидации пользовательских данных используем `zod` - еще одна типобезопасная библиотека. Возможно внутри она и использует касты, но будем опираться на понятие типобезопасной абстракции.  
Еще одно преимущество использования это возможность получить из `zod` схемы типы для TS. Так же `zod` возмжно интегрировать с `Prisma`: при генерации типов для моделй данных типы для TS будут дублироваться в виде `zod` схем для валидации.

## SWC

Люблю RUST и точка.  
А если серьезно, то `swc` на данный момент самая быстрая библиотека компиляции typescript. Пример для данного темплейта на моем железе:

- Холодный старт проекта: 68мс
- Перекомпиляци я в watch режиме: 4мс

С такой скоростью мы ограничены только скоростью самой node-js.  
На данный момент `swc` не поддерживает полноценный бандлинг проектов, но при желании его можно использовать в качестве лоадера для webpack или rollup, которые уже соберут проект в один файл.

## F.A.Q по работе с проектом

### Первоначальный запуск

Устанавливаем зависимости и настраиваем husky:

```bash
yarn && yarn prepare
```

Создаем свой `.env` файл по примеру из `.env.example`.  
Применяем все миграции к нашей тестовой базе данных и генерируем TS типы и zod схемы на основе схемы БД. Папка `src/modelSchemas` создается автоматически, не нужно ничего в ней менять.

```bash
yarn prisma migrate dev
```

Запускаем проект и наслаждаемся.

```bash
yarn dev
```

### Добавление миграций в БД

Призма самостоятельно сгенерирует миграции на основе разницы между последней и вашей схемой. Все, что нужно сделать, это запустить следующую команду после изсенения схемы:

```bash
yarn prisma migrate dev --name <migration_name>
```

### Проблемы с Prisma

Не сгенерировались типы для схемы БЫ. Принудительно генерируем их повторно через

```bash
yarn prisma generate
```

Не получается применить миграции на чужой ветке. Скорее всего в миграциях конфликты с текущей схемы. Проще всего перегенерировать БД с нуля.

```bash
yarn prisma migrate reset
```
